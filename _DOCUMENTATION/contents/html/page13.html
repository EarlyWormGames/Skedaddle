<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.14"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Skedaddle: Extending Final IK</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
  $(document).ready(initResizable);
/* @license-end */</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="lorisicon.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Skedaddle
   &#160;<span id="projectnumber">1.0.0</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.14 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('page13.html','');});
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">Extending Final IK </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>The IK solvers and rotation limits of FinalIK were built from the ground up with extendability in mind. <br />
Some of the components of FinalIK, such as BipedIK, are essentially little more than just collections of IK solvers.</p>
<h1><a class="anchor" id="customcomponents"></a>
Writing Custom IK Components</h1>
<p>Before you can exploit the full power of FinalIK, it is important to know a few things about it's architecture.</p>
<p><b>The difference between IK components and IK solvers:</b> <br />
 By architecture, IK solver is a class that actually contains the inverse kinematics functionality, while the function of an IK component is only to harbor, initiate and update it's solver and provide helpful scene view handles as well as custom inspectors. <br />
 <br />
 Therefore, IK solvers are fully independent of their components and can even be used without them through direct reference:</p>
<div class="fragment"><div class="line"><span class="keyword">using</span> <a class="code" href="namespace_root_motion.html">RootMotion</a>.<a class="code" href="namespace_root_motion_1_1_final_i_k.html">FinalIK</a>;</div><div class="line"></div><div class="line"><span class="keyword">public</span> IKSolverCCD spine = <span class="keyword">new</span> IKSolverCCD();</div><div class="line"><span class="keyword">public</span> IKSolverLimb limb = <span class="keyword">new</span> IKSolverLimb();</div><div class="line"></div><div class="line"><span class="keywordtype">void</span> Start() {</div><div class="line">    <span class="comment">// The root transform reference is used in the initiation of IK solvers for multiple reasons depending on the solver.</span></div><div class="line">    <span class="comment">// heuristic solvers IKSolverCCD, IKSolverFABRIK and IKSolverAim only need it as context for logging warnings, </span></div><div class="line">    <span class="comment">// character solvers IKSolverLimb, IKSolverLookAt, BipedIK and IKSolverFullBodyBiped use it to define their orientation relative to the character,</span></div><div class="line">    <span class="comment">// IKSolverFABRIKRoot uses it as the root of all of it&#39;s FABRIK chains.</span></div><div class="line">    spine.Initiate(transform);</div><div class="line">    limb.Initiate(transform);</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">void</span> LateUpdate() {</div><div class="line">    <span class="comment">// Updating the IK solvers in a specific order.</span></div><div class="line">    <span class="comment">// In the case of multiple IK solvers handling a bone hierarchy, it is usually wise to solve the parents first.</span></div><div class="line">    spine.Update();</div><div class="line">    limb.Update();</div><div class="line">}</div></div><!-- fragment --><p> You now have essentially a custom IK component. <br />
This can be helpful if you needed to keep all the functionality of your IK system in a single component, like BipedIK, so you would not have to manage many different IK components in your scene.</p>
<h1><a class="anchor" id="customrotationlimits"></a>
Writing Custom Rotation Limits</h1>
<p>All rotation limits in Final IK extend from the abstract RotationLimit class. To compose your own, you would as well need to extend from this base class and override the abstract method </p><div class="fragment"><div class="line"><span class="keyword">protected</span> <span class="keyword">abstract</span> Quaternion LimitRotation(Quaternion rotation); </div></div><!-- fragment --><p>In this method you will have to apply the constraint to and return the input Quaternion. <br />
It is important to note that the input Quaternion is already converted to the default local rotation space of the gameobject, meaning if you return Quaternion.identity, the gameobject will always remain fixed to it's initial local rotation.</p>
<p>The following code could be a template for a custom rotation limit:</p>
<div class="fragment"><div class="line"><span class="keyword">using</span> <a class="code" href="namespace_root_motion.html">RootMotion</a>.<a class="code" href="namespace_root_motion_1_1_final_i_k.html">FinalIK</a>;</div><div class="line"></div><div class="line"><span class="comment">// Declaring the class and extending from RotationLimit.cs</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">class </span>RotationLimitCustom: RotationLimit {</div><div class="line">    </div><div class="line">    <span class="comment">// Limits the rotation in the local space of this instance&#39;s Transform.</span></div><div class="line">    <span class="keyword">protected</span> <span class="keyword">override</span> Quaternion LimitRotation(Quaternion rotation) {      </div><div class="line">        <span class="keywordflow">return</span> MyLimitFunction(rotation);</div><div class="line">    }</div><div class="line"></div><div class="line">}</div></div><!-- fragment --><p> The new rotation limit gets recognized and applied automatically by all constrainable IK solvers.</p>
<h1><a class="anchor" id="combining"></a>
Combining IK Components</h1>
<p>When creating more complex IK systems, you will probably need full control over the updating order of your solvers. To do that, you can just disable their components and manage their solvers from an external script. <br />
All IK components extend from the abstract IK class and all IK solvers extend from the abstract IKSolver class. This enables you to easily handle or replace the solvers even without needing to know the specific type of the solver. <br />
Controlling the updating order of multiple IK components: </p><div class="fragment"><div class="line"><span class="keyword">using</span> <a class="code" href="namespace_root_motion.html">RootMotion</a>.<a class="code" href="namespace_root_motion_1_1_final_i_k.html">FinalIK</a>;</div><div class="line"></div><div class="line"><span class="comment">// Array of IK components that you can assign from the inspector. </span></div><div class="line"><span class="comment">// IK is abstract, so it does not matter which specific IK component types are used.</span></div><div class="line"><span class="keyword">public</span> IK[] components;</div><div class="line">    </div><div class="line"><span class="keywordtype">void</span> Start() {</div><div class="line">    <span class="comment">// Disable all the IK components so they won&#39;t update their solvers. Use Disable() instead of enabled = false, the latter does not guarantee solver initiation.</span></div><div class="line">    <span class="keywordflow">foreach</span> (IK component <span class="keywordflow">in</span> components) component.Disable();</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">void</span> LateUpdate() {</div><div class="line">    <span class="comment">// Updating the IK solvers in a specific order. </span></div><div class="line">    <span class="keywordflow">foreach</span> (IK component <span class="keywordflow">in</span> components) component.GetIKSolver().Update();</div><div class="line">}</div></div><!-- fragment --><p><b>Animate Physics</b> <br />
When your character has Animate Physics checked (UpdateMode.AnimatePhysics since Unity 4.5), you will need to check if a FixedUpdate has been called before updating the IK solvers in LateUpdate. Otherwise the IK solvers will be updated multiple times before the Animator/Animation overwrites the pose and accumulate resulting in a high frequency flicker. So the way to update the solvers with Animate Physics would be like this;</p>
<div class="fragment"><div class="line"><span class="keyword">using</span> <a class="code" href="namespace_root_motion.html">RootMotion</a>.<a class="code" href="namespace_root_motion_1_1_final_i_k.html">FinalIK</a>;</div><div class="line"></div><div class="line"><span class="comment">// Array of IK components that you can assign from the inspector. </span></div><div class="line"><span class="comment">// IK is abstract, so it does not matter which specific IK component types are used.</span></div><div class="line"><span class="keyword">public</span> IK[] components;</div><div class="line"></div><div class="line"><span class="keyword">private</span> <span class="keywordtype">bool</span> updateFrame;</div><div class="line">    </div><div class="line"><span class="keywordtype">void</span> Start() {</div><div class="line">    <span class="comment">// Disable all the IK components so they won&#39;t update their solvers. Use Disable() instead of enabled = false, the latter does not guarantee solver initiation.</span></div><div class="line">    <span class="keywordflow">foreach</span> (IK component <span class="keywordflow">in</span> components) component.Disable();</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">void</span> FixedUpdate() {</div><div class="line">    updateFrame = <span class="keyword">true</span>;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">void</span> LateUpdate() {</div><div class="line">    <span class="comment">// Do nothing if FixedUpdate has not been called since the last LateUpdate</span></div><div class="line">    <span class="keywordflow">if</span> (!updateFrame) <span class="keywordflow">return</span>;</div><div class="line">    updateFrame = <span class="keyword">false</span>;</div><div class="line">    </div><div class="line">    <span class="comment">// Updating the IK solvers in a specific order. </span></div><div class="line">    <span class="keywordflow">foreach</span> (IK component <span class="keywordflow">in</span> components) component.GetIKSolver().Update();</div><div class="line">}</div></div><!-- fragment --> </div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.14 </li>
  </ul>
</div>
</body>
</html>
